#docker run -p 3000:8080  auth:1.0
#docker build --build-arg USER=gouser -t auth:1.6 .

#we use multistage docker image. First stage is called build and is used
#for building app in container where go and git exists..
FROM golang:1.12 as build

# specifying default value if user is not defined
ARG USER=appuser

RUN mkdir /app /build

WORKDIR /build

#copy from build context to workdir
# COPY . .

#Do all in one layer otherwise downloaded data stay in previous layers
#and if we delete them in upcomming layer it will not have effect
RUN git clone http://github.com/kuritka/break-down.io . && \
    go mod init github.com/kuritka/break-down.io && \
    go list -e $(go list -f . -m all) && \
    go build -o main . && \
    mv './templates' './static' 'main' 'config.json' /app && \
    #remove all files directories and hidden dirs like .git, .idea...
    rm -rf .[^.] .??* ./*


WORKDIR /app

ENTRYPOINT ["./main"]